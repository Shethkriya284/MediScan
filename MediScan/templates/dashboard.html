{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="welcome-section">
                <h1>Welcome back, {{ current_user.username }}!</h1>
                <p>Here's your health overview for today</p>
            </div>
            <div class="quick-actions">
                <a href="{{ url_for('book_appointment') }}" class="btn btn-light text-primary fw-bold"
                    style="border-radius: 25px;">
                    <i class="fas fa-calendar-plus"></i> New Appointment
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Notifications Section -->
        {% if notifications %}
        <div class="notifications-section mb-4">
            <h4><i class="fas fa-bell"></i> Recent Notifications</h4>
            <div class="notifications-grid">
                {% for notif in notifications %}
                <div class="notification-card alert-warning">
                    <div class="notification-content">
                        <span class="notification-text">{{ notif.message }}</span>
                        <small class="notification-time">{{ notif.timestamp.strftime('%Y-%m-%d') }}</small>
                    </div>
                    <a href="{{ url_for('mark_read', id=notif.id) }}" class="notification-close">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Enhanced Dashboard Stats -->
        <div class="dashboard-stats-enhanced">
            <div class="stat-card appointments">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ appointments|length }}</div>
                    <div class="stat-label">Appointments</div>
                    <div class="stat-trend">{{ appointments|selectattr('status', 'equalto', 'Scheduled')|list|length }}
                        upcoming</div>
                </div>
            </div>
            <a href="{{ url_for('reports') }}" class="stat-card reports"
                style="text-decoration: none; color: inherit; cursor: pointer;">
                <div class="stat-icon">
                    <i class="fas fa-file-medical"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ reports_count if reports_count is defined else 0 }}</div>
                    <div class="stat-label">Reports</div>
                    <div class="stat-trend">{{ appointments|selectattr('status', 'equalto', 'Completed')|list|length }}
                        completed</div>
                </div>
            </a>
            <a href="{{ url_for('consultations') }}" class="stat-card consultations"
                style="text-decoration: none; color: inherit; cursor: pointer;">
                <div class="stat-icon">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ consultations_count if consultations_count is defined else 0 }}</div>
                    <div class="stat-label">Consultations</div>
                    <div class="stat-trend">All time</div>
                </div>
            </a>
            <a href="{{ url_for('health_tracker') }}" class="stat-card health-score"
                style="text-decoration: none; color: inherit; cursor: pointer;">
                <div class="stat-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ health_score if health_score is defined else 85 }}%</div>
                    <div class="stat-label">Health Score</div>
                    <div class="stat-trend">{% if health_score >= 80 %}Excellent{% elif health_score >= 60 %}Good{% else
                        %}Needs Attention{% endif %}</div>
                </div>
            </a>
        </div>

        <!-- Main Dashboard Content -->
        <div class="dashboard-grid">
            <!-- My Rewards Card -->
            <div class="dashboard-card mb-4" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h3><i class="fas fa-gift text-warning"></i> My Rewards</h3>
                </div>
                {% if current_user.rewards %}
                <div class="d-flex gap-3 overflow-auto pb-3">
                    {% for reward in current_user.rewards|reverse %}
                    <div class="reward-card {{ 'scratched' if reward.is_scratched else 'unscratched' }}"
                        onclick="openRewardModal({{ reward.id }}, '{{ reward.reward_type }}', '{{ reward.description }}', {{ 'true' if reward.is_scratched else 'false' }})"
                        style="min-width: 200px; height: 120px; border-radius: 12px; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.2s;">

                        {% if reward.is_scratched %}
                        <div
                            class="bg-white border h-100 p-3 d-flex flex-column justify-content-center align-items-center text-center">
                            <span class="fs-4">{{ 'üí∞' if reward.reward_type == 'Cashback' else 'üéüÔ∏è' }}</span>
                            <small class="fw-bold text-dark">{{ reward.reward_type }}</small>
                            <small class="text-muted" style="font-size: 0.7rem;">{{ reward.description[:20]
                                }}...</small>
                        </div>
                        {% else %}
                        <div class="bg-gradient-warning h-100 d-flex justify-content-center align-items-center"
                            style="background: linear-gradient(45deg, #FFD700, #FFA500);">
                            <i class="fas fa-gift text-white fa-2x"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No rewards yet. Book appointments to win!</p>
                {% endif %}
            </div>

            <!-- Appointments Card -->
            <div class="dashboard-card appointments-card">
                <div class="card-header">
                    <h3><i class="fas fa-calendar-alt"></i> Upcoming Appointments</h3>
                </div>
                {% if appointments %}
                <div class="appointments-list">
                    {% for appt in appointments[:3] %}
                    <div class="appointment-item-dashboard">
                        <div class="appointment-date-badge">
                            <span class="date">{{ appt.date_time.strftime('%d') }}</span>
                            <span class="month">{{ appt.date_time.strftime('%b') }}</span>
                        </div>
                        <div class="appointment-details">
                            {% set doctor = appt.doctor_profile if appt.doctor_profile else None %}
                            <h4>{{ doctor.user.username if doctor else 'Doctor' }}</h4>
                            <p>{{ doctor.specialization if doctor else 'General' }}</p>
                            <span class="time">{{ appt.date_time.strftime('%I:%M %p') }}</span>
                        </div>
                        <div class="appointment-status">
                            <span class="status-badge {{ appt.status.lower() }}">{{ appt.status }}</span>
                        </div>
                        <div class="appointment-actions-dashboard">
                            {% if appt.status != 'Cancelled' and appt.status != 'Completed' %}
                            <button class="btn-action-sm reschedule" onclick="rescheduleAppointment({{ appt.id }})"
                                title="Reschedule">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                            <button class="btn-action-sm cancel" onclick="cancelAppointment({{ appt.id }})"
                                title="Cancel">
                                <i class="fas fa-times-circle"></i>
                            </button>
                            {% endif %}
                            {% if appt.status == 'Cancelled' or appt.status == 'Completed' %}
                            <button class="btn-action-sm delete" onclick="deleteAppointment({{ appt.id }})"
                                title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <a href="{{ url_for('doctors') }}" class="btn btn-primary" style="width: 100%; padding: 0.75rem;">
                        <i class="fas fa-calendar-plus"></i> Book New Appointment
                    </a>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-plus"></i>
                    <p>No upcoming appointments</p>
                    <a href="{{ url_for('book_appointment') }}" class="btn btn-outline-primary">Schedule Now</a>
                </div>
                {% endif %}
            </div>

            <!-- Health Insights Card -->
            <div class="dashboard-card health-insights">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Health Insights</h3>
                    <span class="card-badge">AI Powered</span>
                </div>
                <div class="insights-content">
                    <div class="insight-item">
                        <div class="insight-icon good">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="insight-text">
                            <h4>Great Progress!</h4>
                            <p>Your medication adherence is 95% this month</p>
                        </div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-icon warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="insight-text">
                            <h4>Reminder</h4>
                            <p>Annual health checkup due in 2 weeks</p>
                        </div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-icon info">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="insight-text">
                            <h4>Health Tip</h4>
                            <p>Stay hydrated - aim for 8 glasses of water daily</p>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Live Updates Carousel -->
            <div class="dashboard-card live-updates-card" style="grid-column: 1 / -1;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-satellite-dish text-danger"></i> Live Health Feed</h3>
                    <span class="badge bg-danger animate-pulse">LIVE</span>
                </div>
                <div id="liveFeedCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <div class="d-flex align-items-center gap-3 p-2">
                                <i class="fas fa-user-md fa-2x text-primary"></i>
                                <div>
                                    <h5 class="mb-0">Dr. Sarah available now</h5>
                                    <small class="text-muted">General Physician ‚Ä¢ 2 min wait time</small>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="d-flex align-items-center gap-3 p-2">
                                <i class="fas fa-virus fa-2x text-warning"></i>
                                <div>
                                    <h5 class="mb-0">Seasonal Flu Alert</h5>
                                    <small class="text-muted">Cases rising in your area. Stay safe!</small>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="d-flex align-items-center gap-3 p-2">
                                <i class="fas fa-carrot fa-2x text-success"></i>
                                <div>
                                    <h5 class="mb-0">Daily Tip</h5>
                                    <small class="text-muted">Eating carrots improves vision health.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="dashboard-card quick-actions-card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="actions-grid">

                    <a href="{{ url_for('medicine_tracker') }}" class="action-item">
                        <div class="action-icon medicine">
                            <i class="fas fa-pills"></i>
                        </div>
                        <span>Medicine Tracker</span>
                    </a>
                    <a href="{{ url_for('lab_analysis') }}" class="action-item">
                        <div class="action-icon analysis">
                            <i class="fas fa-flask"></i>
                        </div>
                        <span>Lab Analysis</span>
                    </a>

                    <a href="{{ url_for('appointments') }}" class="action-item">
                        <div class="action-icon prescription">
                            <i class="fas fa-file-prescription"></i>
                        </div>
                        <span>Recent Prescription</span>
                    </a>

                    <a href="{{ url_for('health_tracker') }}" class="action-item">
                        <div class="action-icon tracker">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <span>View Tracker</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scratch Modal Fragment -->
<div class="modal fade" id="rewardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 bg-transparent">
            <div class="modal-body text-center" style="perspective: 1000px;">
                <div id="dash-scratch-card"
                    style="width: 300px; height: 300px; margin: 0 auto; position: relative; cursor: pointer; transform-style: preserve-3d; transition: transform 0.6s;">
                    <!-- Front -->
                    <div class="scratch-front"
                        style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: linear-gradient(45deg, #FFD700, #FFA500); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);">
                        <div class="text-white">
                            <i class="fas fa-gift fa-4x mb-3 fa-beat"></i>
                            <h3 class="fw-bold">Scratch to Win!</h3>
                        </div>
                    </div>
                    <!-- Back -->
                    <div class="scratch-back"
                        style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); background: white; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                        <div id="dash-reward-icon" class="mb-3 display-4">üéâ</div>
                        <h4 id="dash-reward-type" class="fw-bold text-primary mb-2">Reward</h4>
                        <p id="dash-reward-desc" class="text-muted mb-4">Desc</p>
                        <button class="btn btn-primary rounded-pill px-4" onclick="location.reload()">Great!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openRewardModal(id, type, desc, isScratched) {
        if (isScratched) {
            // If already scratched, just show alert or simple view (handling as needed)
            // For now, let's allow re-viewing via the same modal but flipped
            // Setup content
            document.getElementById('dash-reward-type').innerText = type;
            document.getElementById('dash-reward-desc').innerText = desc;
            document.getElementById('dash-reward-icon').innerText = type === 'Cashback' ? 'üí∞' : 'üéüÔ∏è';

            const card = document.getElementById('dash-scratch-card');
            card.style.transform = 'rotateY(180deg)'; // Show back immediately
            new bootstrap.Modal(document.getElementById('rewardModal')).show();
            return;
        }

        // Setup content
        document.getElementById('dash-reward-type').innerText = type;
        document.getElementById('dash-reward-desc').innerText = desc;
        document.getElementById('dash-reward-icon').innerText = type === 'Cashback' ? 'üí∞' : 'üéüÔ∏è';

        // Reset card state
        const card = document.getElementById('dash-scratch-card');
        card.style.transform = 'rotateY(0deg)';

        // Modal
        const modal = new bootstrap.Modal(document.getElementById('rewardModal'));
        modal.show();

        // Scratch action
        card.onclick = async function () {
            if (this.style.transform === 'rotateY(180deg)') return; // Already flipped

            this.style.transform = 'rotateY(180deg)';

            // Call API to mark scratched
            try {
                await fetch(`/api/reward/scratch/${id}`, { method: 'POST' });
            } catch (e) {
                console.error("Error marking scratched", e);
            }
        };
    }
</script>

.dashboard-header {
background: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%);
color: white;
padding: 2rem 0;
margin-bottom: 2rem;
}

.header-content {
max-width: 1200px;
margin: 0 auto;
padding: 0 2rem;
display: flex;
justify-content: space-between;
align-items: center;
}

.welcome-section h1 {
font-size: 2.5rem;
font-weight: 800;
margin-bottom: 0.5rem;
}

.welcome-section p {
font-size: 1.2rem;
opacity: 0.9;
}

.quick-actions {
display: flex;
gap: 1rem;
}

.dashboard-stats-enhanced {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 1.5rem;
margin-bottom: 2rem;
}

.stat-card {
background: white;
border-radius: 15px;
padding: 1.5rem;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
display: flex;
align-items: center;
gap: 1rem;
transition: all 0.3s ease;
}

.stat-card:hover {
transform: translateY(-5px);
box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
}

.stat-icon {
width: 60px;
height: 60px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.5rem;
color: white;
}

.stat-card.appointments .stat-icon {
background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.stat-card.reports .stat-icon {
background: linear-gradient(135deg, #10b981, #059669);
}

.stat-card.consultations .stat-icon {
background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.stat-card.health-score .stat-icon {
background: linear-gradient(135deg, #ef4444, #dc2626);
}

.stat-value {
font-size: 2rem;
font-weight: 800;
color: #1f2937;
line-height: 1;
}

.stat-label {
color: #6b7280;
font-weight: 600;
margin-bottom: 0.25rem;
}

.stat-trend {
font-size: 0.8rem;
color: #10b981;
font-weight: 600;
}

.dashboard-grid {
display: grid;
grid-template-columns: 2fr 1fr;
gap: 2rem;
}

.dashboard-card {
background: white;
border-radius: 20px;
padding: 2rem;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.dashboard-card:hover {
transform: translateY(-3px);
box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.appointments-card {
grid-row: span 2;
}

.notifications-grid {
display: grid;
gap: 1rem;
}

.notification-card {
background: #fef3c7;
border: 1px solid #f59e0b;
border-radius: 12px;
padding: 1rem;
display: flex;
justify-content: space-between;
align-items: center;
}

.actions-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 1rem;
}

.action-item {
display: flex;
flex-direction: column;
align-items: center;
gap: 0.5rem;
padding: 1rem;
background: #f8fafc;
border-radius: 12px;
text-decoration: none;
color: #374151;
transition: all 0.3s ease;
}

.action-item:hover {
background: #e2e8f0;
transform: translateY(-2px);
}

.action-icon {
width: 50px;
height: 50px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 1.2rem;
}

.action-icon.symptom {
background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.action-icon.medicine {
background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.action-icon.doctor {
background: linear-gradient(135deg, #10b981, #059669);
}

.action-icon.analysis {
background: linear-gradient(135deg, #f59e0b, #d97706);
}

.action-icon.prescription {
background: linear-gradient(135deg, #0ea5e9, #0284c7);
}

.action-icon.tracker {
background: linear-gradient(135deg, #ec4899, #db2777);
}

.animate-pulse {
animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: .5; }
}

.insights-content {
display: flex;
flex-direction: column;
gap: 1rem;
}

.insight-item {
display: flex;
align-items: center;
gap: 1rem;
padding: 1rem;
background: #f8fafc;
border-radius: 12px;
}

.insight-icon {
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
color: white;
}

.insight-icon.good {
background: #10b981;
}

.insight-icon.warning {
background: #f59e0b;
}

.insight-icon.info {
background: #3b82f6;
}

@media (max-width: 768px) {
.header-content {
flex-direction: column;
gap: 1rem;
text-align: center;
}

.dashboard-stats-enhanced {
grid-template-columns: repeat(2, 1fr);
}

.dashboard-grid {
grid-template-columns: 1fr;
}

.actions-grid {
grid-template-columns: 1fr;
}
}
</style>

<script>
    // Appointment Management Functions
    function cancelAppointment(appointmentId) {
        if (confirm('Are you sure you want to cancel this appointment?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/cancel_appointment/${appointmentId}`;
            document.body.appendChild(form);
            form.submit();
        }
    }

    function deleteAppointment(appointmentId) {
        if (confirm('Are you sure you want to permanently delete this appointment? This action cannot be undone.')) {
            window.location.href = `/appointment/delete/${appointmentId}`;
        }
    }

    function rescheduleAppointment(appointmentId) {
        if (confirm('Do you want to reschedule this appointment?')) {
            window.location.href = `/appointment/reschedule/${appointmentId}`;
        }
    }
</script>
{% endblock %}