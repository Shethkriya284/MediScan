{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 900px; height: 85vh; padding-top: 1rem;">
    <div class="card"
        style="height: 100%; display: flex; flex-direction: column; padding: 0; overflow: hidden; border: none; box-shadow: var(--shadow-lg);">

        <!-- Chat Header -->
        <div
            style="background: #075e54; color: white; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem;">
            <div
                style="width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #075e54; font-size: 1.5rem;">
                <i class="fa-solid fa-robot"></i>
            </div>
            <div>
                <h4 style="color: white; margin: 0; font-size: 1.1rem;">MediScan AI Assistant</h4>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.9;">Online | Reply time: Instant</p>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box"
            style="flex: 1; background: #efeae2; padding: 2rem; overflow-y: auto; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');">
            <!-- Messages will be appended here -->
            <div class="message incoming">
                <div class="bubble">
                    <p>Hello! I am your AI Health Assistant. How can I help you today?</p>
                    <span class="time">Now</span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding: 1rem; background: #f0f2f5; display: flex; gap: 1rem; align-items: center;">
            <input type="text" id="message-input" class="form-control" placeholder="Type a message..."
                style="border-radius: 2rem; padding: 0.8rem 1.5rem; border: none; box-shadow: var(--shadow-sm);">
            <button onclick="sendMessage()" class="btn"
                style="background: #008069; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm);">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='vendor/socket.io/socket.io.js') }}"></script>
<script type="text/javascript">
    const socket = io();
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('message-input');
    const username = "{{ current_user.username }}";

    socket.on('connect', function () {
        console.log('Connected to Chat Server');
        socket.emit('join', { username: username });
    });

    socket.on('message', function (data) {
        if (data.user !== username) {
            appendMessage(data.msg, 'incoming', data.user);
        }
    });

    function sendMessage() {
        const msg = input.value;
        if (msg.trim() !== "") {
            socket.emit('message', { msg: msg, room: null }); // Broadcast for now
            appendMessage(msg, 'outgoing', 'You');
            input.value = '';
        }
    }

    input.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function appendMessage(text, type, sender) {
        const div = document.createElement('div');
        div.classList.add('message', type);

        const bubble = document.createElement('div');
        bubble.classList.add('bubble');

        const content = `<p>${text}</p><span class="time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
        bubble.innerHTML = content;

        div.appendChild(bubble);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

<style>
    .message {
        display: flex;
        margin-bottom: 1rem;
    }

    .message.incoming {
        justify-content: flex-start;
    }

    .message.outgoing {
        justify-content: flex-end;
    }

    .bubble {
        max-width: 70%;
        padding: 0.8rem 1rem;
        border-radius: 0.5rem;
        position: relative;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message.incoming .bubble {
        background: white;
        border-radius: 0 1rem 1rem 1rem;
    }

    .message.outgoing .bubble {
        background: #d9fdd3;
        border-radius: 1rem 0 1rem 1rem;
    }

    .time {
        display: block;
        font-size: 0.65rem;
        color: #999;
        text-align: right;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}